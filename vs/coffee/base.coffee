# @codekit-prepend "../../libs/js/min/preloadjs-0.4.1.min.js"
# @codekit-prepend "../../libs/coffee/css3Prefix"
# @codekit-prepend "../../libs/coffee/requestanimation"
# @codekit-prepend "coffee/global"
# @codekit-prepend "../../libs/coffee/share"
# @codekit-prepend "../../libs/coffee/load"

# load list
debug = true

loadList = [
	{id: "logo", src:"img/loading-normal.png"}
]

_wechat_f = 
	"appid": ""
	"img_url": "http://campaign.douban.com/files/campaign/vs_rockalbumcover/img/share.jpg"
	"img_width": 300
	"img_height": 300
	"link": "http://campaign.douban.com/files/campaign/vs_rockalbumcover/default.html"
	"desc": "史上最经典摇滚唱片封面你认识多少？"
	"title": "史上最经典摇滚唱片封面你认识多少？"
_wechat =
	"appid": ""
	"img_url": "http://campaign.douban.com/files/campaign/vs_rockalbumcover/img/share.jpg"
	"img_width": 300
	"img_height": 300
	"link": "http://campaign.douban.com/files/campaign/vs_rockalbumcover/default.html"
	"desc": "史上最经典摇滚唱片封面你认识多少？"
	"title": "史上最经典摇滚唱片封面你认识多少？"
_share_img = "http://campaign.douban.com/files/campaign/vs_rockalbumcover/img/share-pc.jpg"
_share_link = "http://campaign.douban.com/files/campaign/vs_rockalbumcover/default.html"

hosts = "http://g.giccoo.com"

_list = [
	{img:"1",name:"Elvis Presley",author:"Elvis Presley",year:"1956",answer:"对",hide:false}
	{img:"2",name:"Lou Reed",author:"Transformer",year:"1990",answer:"错",hide:false}
	{img:"3",name:"Nirvana",author:"Nevermind",year:"1991",answer:"对",hide:false}
	{img:"4",name:"The Beatles",author:"Revolver",year:"1968",answer:"对",hide:false}
	{img:"5",name:"The Beatles",author:"The Beatles",year:"1967",answer:"错",hide:false}
	{img:"6",name:"The Sex Pistols",author:"Nevermind",year:"1977",answer:"错",hide:false}
	{img:"7",name:"Queen",author:"Pearl",year:"1971",answer:"错",hide:false}
	{img:"8",name:"T. Rex",author:"Electric Warrior",year:"1971",answer:"对",hide:false}
	{img:"9",name:"New Order",author:"Power, Corruption & Lies",year:"1983",answer:"对",hide:false}
	{img:"10",name:"Them",author:"The Original Hit Gloria",year:"1965",answer:"错",hide:false}
	{img:"11",name:"Primal Scream",author:"Screamadelica",year:"1991",answer:"对",hide:false}
	{img:"12",name:"The Shaggs",author:"Philosophy of the World",year:"1969",answer:"对",hide:false}
	{img:"13",name:"Gene Vincent and the Blue Caps",author:"Gene Vincent and the Blue Caps",year:"1967",answer:"错",hide:false}
	{img:"14",name:"Patti Smith",author:"Horses",year:"1975",answer:"对",hide:false}
	{img:"15",name:"King Crimson",author:"In the Court of the King Crimson",year:"1969",answer:"错",hide:false}
	{img:"16",name:"The Clash",author:"London Calling",year:"1979",answer:"对",hide:false}
	{img:"17",name:"Led Zeppelin",author:"Boat",year:"1969",answer:"错",hide:false}
	{img:"18",name:"Led Zeppelin",author:"Led Zeppelin II",year:"1969",answer:"对",hide:false}
	{img:"19",name:"The Surfaris",author:"The Surfaris Play",year:"1963",answer:"对",hide:false}
	{img:"20",name:"Bruce Springsteen",author:"Nebraska",year:"1982",answer:"对",hide:false}
	{img:"21",name:"Sonic Youth",author:"Puppies",year:"1987",answer:"错",hide:false}
	{img:"22",name:"The Rolling Stones",author:"Exile on Main St",year:"1972",answer:"对",hide:false}
	{img:"23",name:"The Kinks",author:"Some Girls",year:"1978",answer:"错",hide:false}
	{img:"24",name:"The Replacements",author:"Sorry Ma, Forgot to Take Out The Trash",year:"1981",answer:"对",hide:false}
	{img:"25",name:"Pixies",author:"5.6.7",year:"1989",answer:"错",hide:false}
	{img:"26",name:"David Bowie",author:"Hunky Dory",year:"1989",answer:"错",hide:false}
	{img:"27",name:"Blondie",author:"Blondie",year:"1976",answer:"对",hide:false}
	{img:"28",name:"KISS",author:"Destroyer",year:"1976",answer:"对",hide:false}
	{img:"29",name:"Elvis Costello",author:"My Aim is True",year:"1990",answer:"错",hide:false}
	{img:"30",name:"Cream",author:"Cream",year:"1967",answer:"错",hide:false}
	{img:"31",name:"KISS",author:"Bad Brains",year:"1982",answer:"错",hide:false}
	{img:"32",name:"Ike & Tina Turner",author:"Dynamite!",year:"1963",answer:"对",hide:false}
	{img:"33",name:"AC/DC",author:"For Those About to Rock ",year:"1981",answer:"对",hide:false}
	{img:"34",name:"Big Brother & the Holding Company",author:"Cheap Thrills",year:"1995",answer:"错",hide:false}
	{img:"35",name:"The Beatles",author:"We're Only in it for the Money",year:"1968",answer:"错",hide:false}
	{img:"36",name:"The Beatles",author:"Abbey Road",year:"1969",answer:"对",hide:false}
	{img:"37",name:"The Beatles",author:"The Beatles",year:"2009",answer:"错",hide:false}
	{img:"38",name:"David Bowie",author:"Aladdin Sane",year:"1973",answer:"对",hide:false}
	{img:"39",name:"Green Day",author:"American Idol",year:"2004",answer:"错",hide:false}
	{img:"40",name:"Guns N' Roses",author:"Appetite For Destruction",year:"1987",answer:"对",hide:false}
	{img:"41",name:"Joy Division",author:"Mountains",year:"1979",answer:"错",hide:false}
	{img:"42",name:"Led Zeppelin",author:"Naked Beach",year:"1973",answer:"错",hide:false}
	{img:"43",name:"Pink Floyd",author:"Dark Side Of The Moon",year:"1973",answer:"对",hide:false}
	{img:"44",name:"Pink Floyd",author:"The Wall",year:"2003",answer:"错",hide:false}
	{img:"45",name:"Metallica",author:"Rage Against The Machine",year:"1986",answer:"错",hide:false}
	{img:"46",name:"The Rolling Stones",author:"Sticky Fingers",year:"1971",answer:"对",hide:false}
	{img:"47",name:"Michael Jackson",author:"Born In The U.S.A",year:"1990",answer:"错",hide:false}
	{img:"48",name:"Andy Wahol",author:"Banana",year:"1967",answer:"错",hide:false}
	{img:"49",name:"Coldplay",author:"Viva La Vida",year:"2008",answer:"对",hide:false}
	{img:"50",name:"Radiohead",author:"OK Computer",year:"1997",answer:"对",hide:false}
]
getList = (i)->
	re = _list.slice(0)[i]
	re.hide = false
	return re

refreshShare = (title)->
	_wechat.title = title
	_wechat_f.title = title
	window.parent.update title if window.parent and window.parent.update
	reloadWechat()


app = angular.module('kelvin', ["ngRoute","ngTouch","ngAnimate"])
.config ["$routeProvider", "$locationProvider" ,($routeProvider, $locationProvider)->
	$routeProvider.when '/',{
		templateUrl: "home.html"
	}
	$routeProvider.when '/question',{
		templateUrl: "question.html"
	}

	$routeProvider.when '/:rd', {
		templateUrl: "home.html"
	}
]
_tempH = 0
# finishedRiver = ->


# 主要加载
app.controller 'MainController', ($rootScope, $scope, $location, $timeout)->
	if $("body").height() <= 440
		$("body").addClass "iphone4"
	beginload $scope
		# for a in loadList
			# $("img[data-lz=#{a.id}]").attr "src", a.src
	$rootScope.$on "$routeChangeSuccess", ->
		LoadFinished "angular",$scope
	$scope.$watch "loaded", ->
		$(".loaded").removeClass "loaded" if $scope.loaded
	if $("body").width() > 768
		$rootScope.shoplink = "http://item.jd.com/1071850.html"
	else
		$rootScope.shoplink = "http://item.m.jd.com/ware/view.action?wareId=1071850"


app.controller 'HomeController', ($rootScope, $scope, $location, $timeout)->
	this.pop = false
	tis = this
	this.go = ->
		# return false
		$rootScope.question = true
		$location.path("/question")
	this.showpop = ->
		tis.pop = true
		$timeout ->
			tis.go()
		,6000
	
app.controller 'QuestionController', ($rootScope, $scope, $location, $timeout, $route)->
	return $location.path "/" unless $rootScope.question
	this.shares = true
	this.over = false
	this.Now = 0
	this.right = 0
	this.list = []
	this._list = _list.slice(0)
	tis = this
	randomRm = ->
		l = tis._list.length
		r = Math.ceil(Math.random()*(l-1))
		b = tis._list[r]
		b.hide = false
		tis._list.splice(r,1)
		return b
	first = randomRm()
	this.list.push(first)
	this.selectAnswer = (answer)->
		q = tis.list[tis.Now]
		if answer and q.answer is "对"
			console.log "答对了"
			tis.right++
		else if not answer and q.answer is "错"
			console.log "答对了"
			tis.right++
		else
			console.log "答错了"
		tis.list[tis.Now].hide = true
		tis.Now++
		if tis.Now >= 10
			# alert "答题完成 #{tis.right}"
			tis.over = true
			if tis.right >= 10
				tis.Textline1 = "你全部认出！"
				tis.Textline2 = "领先99%的摇滚乐迷！"
				tis.Textline3 = "你简直不是人类!!"
				tis.Textline4 = "只有沙宣能够匹配你的摇滚型格了"
				tis.shareText = "10张经典唱片我全部认出！领先99%的摇滚乐迷！不服？来战！"
			else if tis.right >= 7
				tis.Textline1 = "你认出#{tis.right}张！"
				tis.Textline2 = "领先95%的摇滚乐迷！"
				tis.Textline3 = "说，你是不是豆瓣音乐人?!?"
				tis.Textline4 = "赶紧用沙宣打造你的摇滚型格"
				tis.shareText = "10张经典唱片我认出#{tis.right}张！领先95%的摇滚乐迷！不服？来战！"
			else if tis.right >= 4
				tis.Textline1 = "你认出#{tis.right}张！"
				tis.Textline2 = "领先75%的摇滚乐迷！"
				tis.Textline3 = "努力加把劲，再玩一遍？"
				tis.Textline4 = "形象也不能落下，用沙宣提升你的摇滚型格"
				tis.shareText = "10张经典唱片我认出#{tis.right}张！领先75%的摇滚乐迷！不服？来战！"
			else if tis.right >= 1
				tis.Textline1 = "你认出#{tis.right}张！"
				tis.Textline2 = "领先35%的摇滚乐迷！"
				tis.Textline3 = "赶紧到豆瓣FM收听摇滚兆赫恶补一下！"
				tis.Textline3Class = "smallText"
				tis.Textline4 = "形象也不能落下，用沙宣提升你的摇滚型格"
				tis.shareText = "10张经典唱片我认出#{tis.right}张！领先35%的摇滚乐迷！你敢不敢也测试一下？"
			else
				tis.Textline1 = "你全部没有认出！"
				tis.Textline2 = "你是不是真的摇滚乐迷？"
				tis.Textline3 = "赶紧到豆瓣FM收听摇滚兆赫恶补一下！"
				tis.Textline3Class = "smallText"
				tis.Textline4 = "形象也不能落下，用沙宣提升你的摇滚型格"
				tis.shareText = "10张经典唱片我全都没认出来！你来帮一帮我吧"
			refreshShare tis.shareText
		else
			tis.list.push(randomRm())
			console.log tis.list
	this.re = ->
		$route.reload()
	this.showpop = ->
		if $("body").width() > 640
			tis.shares = true
			tis.pop = true
			setTimeout ->
				BindShare tis.shareText,_share_link,_share_img
		else
			tis.wechatnote = true
	this.close = ->
		return tis.shares = true unless tis.shares
		tis.pop = false
	this.showWechat = ->
		tis.shares = false
	this.hideWechatnote = ->
		tis.wechatnote = false





app.controller 'MenuController', ($rootScope, $scope, $location, $timeout)->
	tis = this
	this.menushow = ->
		if tis.type?
			tis.type = null
		else
			tis.type = "open"

app.directive 'soundCtrl', ->
	return {
		restrict: 'EA'
		link: (scope, elem, attrs)->
			# audio#audio(src="#{url}lkk/mp3/audio.mp3",preload)
			audio = document.createElement("audio")
			audio.preload = attrs.preload if attrs.preload?
			audio.autoplay = attrs.autoplay if attrs.autoplay?
			audio.src = attrs.src if attrs.src?
			audio.loop = attrs.loop if attrs.loop?
			elem.append audio
			elem.bind "touchstart click",(e)->
				e.stopPropagation()
				e.preventDefault()
				console.log e,audio.paused
				if audio.paused
					audio.play()
				else
					audio.pause()
			audio.addEventListener "pause", ()->
				console.log "已经暂停"
				scope.$apply ->
					scope.soundclass = "off"
			audio.addEventListener "play", ()->
				console.log "开始播放"
				scope.$apply ->
					scope.soundclass = "on"


	}
